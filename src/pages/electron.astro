---
import Layout from '../layouts/Layout.astro';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { CopyButton } from '@/components/CopyButton';
import { getNpmVersion } from '@/lib/versions';

const version = await getNpmVersion('@harnessgg/electron', '0.1.0');
const install = 'npm install -D @harnessgg/electron';

const c = (cls: string, text: string) => `<span class="${cls}">${text}</span>`;
const comment = (t: string) => c('t-comment', t);
const termCmd = (t: string) => `${c('t-prompt', '$')} ${t}`;
const json = (t: string) => c('t-json', t);
const nl = '\n';

const quickFlowHtml = [
  comment('# 0. Start app with CDP enabled'),
  termCmd('electron . --remote-debugging-port=9222'),
  nl,
  comment('# 1. Discover contract'),
  termCmd('harness-electron schema'),
  nl,
  comment('# 2. Connect'),
  termCmd('harness-electron connect --port 9222'),
  json('{"ok":true,"session":"default","data":{"target":"My App"}}'),
  nl,
  comment('# 3. Inspect DOM'),
  termCmd('harness-electron dom --format summary'),
  json('{"ok":true,"session":"default","data":{"interactive":[{"role":"button","name":"Sign in"}]}}'),
  nl,
  comment('# 4. Query a stable target'),
  termCmd('harness-electron query --role button --name "Sign in"'),
  json('{"ok":true,"session":"default","data":{"elements":[{"elementId":"e1","role":"button","name":"Sign in"}]}}'),
  nl,
  comment('# 5. Interact'),
  termCmd('harness-electron type --css "input[type=email]" --value "user@example.com"'),
  termCmd('harness-electron click --element-id e1'),
  nl,
  comment('# 6. Verify'),
  termCmd('harness-electron assert --kind url --expected "/dashboard"'),
  json('{"ok":true,"session":"default","data":{"actual":"/dashboard"}}'),
  nl,
  comment('# 7. Screenshot'),
  termCmd('harness-electron screenshot --path ./artifacts/dashboard.png'),
  nl,
  comment('# 8. Cleanup'),
  termCmd('harness-electron disconnect'),
].join('\n');

const schemaSuccessHtml = json('{"ok":true,"protocolVersion":"1.0","command":"click","session":"default","data":{"clicked":true,"target":{"elementId":"e1"}}}');
const schemaErrorHtml = json('{"ok":false,"protocolVersion":"1.0","command":"click","session":"default","error":{"code":"TARGET_NOT_FOUND","message":"No element matched selector","retryable":true,"suggestedNext":["dom --format summary"]}}');

const commands = [
  {
    name: 'connect',
    synopsis: 'harness-electron connect --port <n> [--host <h>] [--window-title <t>] [--url-contains <s>]',
    description: 'Connect to an Electron app via CDP. Session is implicit — do not pass --session unless running multi-session flows.',
    flags: [
      { flag: '--port',          req: true,  desc: 'CDP port (e.g. 9222)' },
      { flag: '--host',          req: false, desc: 'Host (default: localhost)' },
      { flag: '--window-title',  req: false, desc: 'Filter targets by window title' },
      { flag: '--url-contains',  req: false, desc: 'Filter targets by URL substring' },
    ],
  },
  {
    name: 'dom',
    synopsis: 'harness-electron dom [--format summary|tree|html] [--max-nodes <n>]',
    description: 'Inspect the DOM. Start with summary to discover interactive elements before targeting.',
    flags: [
      { flag: '--format',    req: false, desc: 'summary | tree | html (default: summary)' },
      { flag: '--max-nodes', req: false, desc: 'Cap node count in output' },
    ],
  },
  {
    name: 'query',
    synopsis: 'harness-electron query <selector> [--limit <n>] [--visible-only]',
    description: 'Resolve elements and return persistent elementIds for reuse in later commands. Prefer over inline selectors for stability.',
    flags: [
      { flag: '--css / --xpath / --text / --role / --testid', req: false, desc: 'Selector strategy (one required)' },
      { flag: '--name',         req: false, desc: 'Accessible name (use with --role)' },
      { flag: '--limit',        req: false, desc: 'Max results' },
      { flag: '--visible-only', req: false, desc: 'Exclude hidden elements' },
    ],
  },
  {
    name: 'click',
    synopsis: 'harness-electron click <target> [--timeout <ms>]',
    description: 'Click an element. Use --element-id from query for stable targeting, or a selector flag.',
    flags: [
      { flag: '--element-id',                                 req: false, desc: 'ID returned by query (preferred)' },
      { flag: '--css / --xpath / --text / --role / --testid', req: false, desc: 'Inline selector (one required if no --element-id)' },
      { flag: '--name',                                       req: false, desc: 'Accessible name (use with --role)' },
      { flag: '--index',                                      req: false, desc: 'Pick nth match (0-based, default 0)' },
      { flag: '--timeout',                                    req: false, desc: 'Max wait ms' },
    ],
  },
  {
    name: 'type',
    synopsis: 'harness-electron type <target> --value <text> [--clear] [--timeout <ms>]',
    description: 'Type text into an input field.',
    flags: [
      { flag: '--value',                                      req: true,  desc: 'Text to type' },
      { flag: '--element-id',                                 req: false, desc: 'ID returned by query' },
      { flag: '--css / --xpath / --role / --testid',          req: false, desc: 'Inline selector' },
      { flag: '--clear',                                      req: false, desc: 'Clear existing content first' },
      { flag: '--timeout',                                    req: false, desc: 'Max wait ms' },
    ],
  },
  {
    name: 'wait',
    synopsis: 'harness-electron wait --for visible|hidden|url|text [<target>] [--value <v>] [--timeout <ms>]',
    description: 'Wait for a condition. Rules: url requires --value and no target; text requires target + --value; visible/hidden require target.',
    flags: [
      { flag: '--for',     req: true,  desc: 'visible | hidden | url | text' },
      { flag: '--value',   req: false, desc: 'Expected value (required for url and text)' },
      { flag: '--timeout', req: false, desc: 'Max wait ms' },
    ],
  },
  {
    name: 'screenshot',
    synopsis: 'harness-electron screenshot --path <file> [--full-page] [<target>] [--timeout <ms>]',
    description: 'Capture a screenshot. No target = viewport. With target = element. --full-page cannot be combined with a target.',
    flags: [
      { flag: '--path',      req: true,  desc: 'Output .png path' },
      { flag: '--full-page', req: false, desc: 'Full-page screenshot (no target allowed)' },
      { flag: '--element-id / --css', req: false, desc: 'Element screenshot' },
      { flag: '--timeout',   req: false, desc: 'Max wait ms' },
    ],
  },
  {
    name: 'assert',
    synopsis: 'harness-electron assert --kind exists|visible|text|url [<target>] [--expected <v>] [--timeout <ms>]',
    description: 'Assert a condition. Returns ok:false with ASSERT_FAIL on failure — treat as test failure, not infrastructure failure.',
    flags: [
      { flag: '--kind',     req: true,  desc: 'exists | visible | text | url' },
      { flag: '--expected', req: false, desc: 'Expected value (required for text and url)' },
      { flag: '--element-id / --css / --xpath', req: false, desc: 'Target (required for exists, visible, text)' },
      { flag: '--timeout',  req: false, desc: 'Max wait ms' },
    ],
  },
  {
    name: 'evaluate',
    synopsis: 'harness-electron evaluate --script <js>',
    description: 'Execute a JavaScript expression in the page context and return the result as JSON.',
    flags: [
      { flag: '--script', req: true, desc: 'JavaScript expression' },
    ],
  },
  {
    name: 'disconnect',
    synopsis: 'harness-electron disconnect',
    description: 'Close the default CDP session.',
    flags: [],
  },
  {
    name: 'sessions',
    synopsis: 'harness-electron sessions list | prune',
    description: 'List persisted sessions or prune stale ones.',
    flags: [],
  },
  {
    name: 'schema',
    synopsis: 'harness-electron schema',
    description: 'Emit machine-readable command and flag schema. Run this first for dynamic discovery.',
    flags: [],
  },
  {
    name: 'capabilities',
    synopsis: 'harness-electron capabilities',
    description: 'Show a human-readable summary of what this harness can do.',
    flags: [],
  },
];

const errorCodes = [
  { code: 'INVALID_INPUT',    exit: 10, retryable: false, desc: 'Bad or missing arguments. Fix the command before retrying.' },
  { code: 'CONNECT_FAILED',   exit: 20, retryable: true,  desc: 'Could not reach CDP port. Verify the app is running with --remote-debugging-port.' },
  { code: 'TARGET_NOT_FOUND', exit: 20, retryable: true,  desc: 'No element matched the selector. Run dom --format summary and retry with a different target.' },
  { code: 'INVALID_SELECTOR', exit: 30, retryable: false, desc: 'Malformed selector. Run dom --format tree to rediscover structure.' },
  { code: 'ACTION_FAILED',    exit: 30, retryable: true,  desc: 'Action executed but failed (e.g. element not interactable). Retry once.' },
  { code: 'TIMEOUT',          exit: 40, retryable: true,  desc: 'Condition did not occur in time. Retry with a larger --timeout.' },
  { code: 'ASSERT_FAIL',      exit: 50, retryable: false, desc: 'Assertion did not pass. Treat as test failure — inspect actual value in error.message.' },
  { code: 'INTERNAL_ERROR',   exit: 70, retryable: true,  desc: 'Unexpected error. Retry once; if it persists, file a bug.' },
];
---

<Layout
  title="@harnessgg/electron | Harness.gg"
  description="CLI harness for AI agents to automate Electron apps via Chrome DevTools Protocol. Connect, query, click, type, assert, screenshot — structured JSON output."
>

  <!-- Header -->
  <section class="pt-10 pb-10 wrap">
    <p class="breadcrumb">
      <a href="/">harness.gg</a>
      <span>/</span>
      electron
    </p>

    <div class="title-row">
      <h1>@harnessgg/electron</h1>
      <Badge className="badge-live">Published</Badge>
      <Badge variant="outline" className="badge-ver">v{version}</Badge>
    </div>

    <p class="tagline">
      CLI harness for AI agents to interact with Electron apps via Chrome DevTools Protocol.
      Connect to any Electron app via CDP. Query elements, click, type, assert, screenshot, and evaluate JavaScript. Session is implicit — one JSON object per command.
    </p>

    <div class="install-row">
      <code>{install}</code>
      <CopyButton client:load text={install} />
    </div>

    <div class="ext-links">
      <a href="https://www.npmjs.com/package/@harnessgg/electron" target="_blank" rel="noopener">
        <Badge variant="outline" className="ext-badge">npm &nearr;</Badge>
      </a>
      <a href="https://github.com/harnessgg/electron" target="_blank" rel="noopener">
        <Badge variant="outline" className="ext-badge">GitHub &nearr;</Badge>
      </a>
      <a href="https://github.com/harnessgg/electron/tree/main/docs/llm" target="_blank" rel="noopener">
        <Badge variant="outline" className="ext-badge">LLM docs &nearr;</Badge>
      </a>
    </div>
    <p class="note">Agents can file bugs or feature requests with <code class="inline-code">curl -X POST https://harness.gg/api/submit</code> using <code class="inline-code">"package":"electron"</code> in the JSON payload.</p>
  </section>

  <Separator />

  <!-- Prerequisite -->
  <section class="wrap sec">
    <h2>Prerequisite</h2>
    <p class="sec-intro">Launch your Electron app with the CDP debugging port exposed:</p>
    <div class="term-block">
      <div class="term-bar">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        <span class="term-title">terminal</span>
      </div>
      <pre class="term-body"><span class="t-prompt">$</span> electron . --remote-debugging-port=9222</pre>
    </div>
    <p class="note">Node.js &ge; 20 required.</p>
  </section>

  <Separator />

  <!-- Quick flow -->
  <section class="wrap sec">
    <h2>Quick flow</h2>
    <div class="term-block">
      <div class="term-bar">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        <span class="term-title">full agent session</span>
      </div>
      <pre class="term-body" set:html={quickFlowHtml}></pre>
    </div>
  </section>

  <Separator />

  <section class="wrap sec">
    <h2>Schema examples</h2>
    <p class="sec-intro">Each command returns one JSON object. Parse <code class="inline-code">ok</code>, then use <code class="inline-code">data</code> or <code class="inline-code">error</code>.</p>
    <div class="term-block">
      <div class="term-bar">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        <span class="term-title">success</span>
      </div>
      <pre class="term-body" set:html={schemaSuccessHtml}></pre>
    </div>
    <div class="term-block" style="margin-top:12px;">
      <div class="term-bar">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        <span class="term-title">error</span>
      </div>
      <pre class="term-body" set:html={schemaErrorHtml}></pre>
    </div>
  </section>

  <Separator />

  <!-- Command reference -->
  <section class="wrap sec" id="commands">
    <h2>Command reference</h2>
    <div class="cmd-list">
      {commands.map(command => (
        <div class="cmd-card" id={`cmd-${command.name}`}>
          <div class="cmd-head">
            <code class="cmd-name">{command.name}</code>
          </div>
          <pre class="cmd-synopsis">{command.synopsis}</pre>
          <p class="cmd-desc">{command.description}</p>
          {command.flags.length > 0 && (
            <table class="flag-table">
              <thead>
                <tr><th>Flag</th><th>Required</th><th>Description</th></tr>
              </thead>
              <tbody>
                {command.flags.map(f => (
                  <tr>
                    <td><code>{f.flag}</code></td>
                    <td class={f.req ? 'req-yes' : 'req-no'}>{f.req ? 'yes' : 'no'}</td>
                    <td>{f.desc}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      ))}
    </div>
  </section>

  <Separator />

  <!-- Response shape -->
  <section class="wrap sec">
    <h2>Response shape</h2>
    <p class="sec-intro">Every command writes a single JSON object to stdout. Check <code class="inline-code">ok</code> first.</p>

    <div class="shape-grid">
      <div>
        <p class="shape-label">Success</p>
        <pre class="code-block">{`{
  "ok": true,
  "protocolVersion": "1.0",
  "command": "click",
  "session": "ses_a1b2c3",
  "data": { "selector": "[role=button]" }
}`}</pre>
      </div>
      <div>
        <p class="shape-label">Error</p>
        <pre class="code-block">{`{
  "ok": false,
  "protocolVersion": "1.0",
  "command": "click",
  "session": "ses_a1b2c3",
  "error": {
    "code": "TARGET_NOT_FOUND",
    "message": "No element matched",
    "retryable": true,
    "suggestedNext": ["dom --format summary"]
  }
}`}</pre>
      </div>
    </div>

    <table class="flag-table">
      <thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead>
      <tbody>
        <tr><td><code>ok</code></td><td>boolean</td><td>true on success, false on error</td></tr>
        <tr><td><code>protocolVersion</code></td><td>string</td><td>Always "1.0"</td></tr>
        <tr><td><code>command</code></td><td>string</td><td>The command that was run</td></tr>
        <tr><td><code>session</code></td><td>string</td><td>Session ID (ses_xxx)</td></tr>
        <tr><td><code>data</code></td><td>object</td><td>Command-specific payload (success only)</td></tr>
        <tr><td><code>error</code></td><td>object</td><td>code, message, retryable, suggestedNext (error only)</td></tr>
      </tbody>
    </table>
  </section>

  <Separator />

  <!-- Error codes -->
  <section class="wrap sec">
    <h2>Error codes</h2>
    <table class="flag-table">
      <thead><tr><th>Code</th><th>Exit</th><th>Retryable</th><th>Action</th></tr></thead>
      <tbody>
        {errorCodes.map(e => (
          <tr>
            <td><code>{e.code}</code></td>
            <td class="mono-cell">{e.exit}</td>
            <td class={e.retryable ? 'req-yes' : 'req-no'}>{e.retryable ? 'yes' : 'no'}</td>
            <td>{e.desc}</td>
          </tr>
        ))}
      </tbody>
    </table>
  </section>

  <Separator />

  <!-- Submit feedback -->
  <section class="wrap sec">
    <h2>Submit feedback</h2>
    <p class="sec-intro">
      Agents can file bug reports and feature requests via <code class="inline-code">POST /api/submit</code>.
      Issues land on <a href="https://github.com/harnessgg/electron" target="_blank" rel="noopener">harnessgg/Harness-electron</a>.
    </p>

    <table class="flag-table" style="margin-bottom: 1.5rem">
      <thead><tr><th>Field</th><th>Required</th><th>Values</th></tr></thead>
      <tbody>
        <tr><td><code>type</code></td><td class="req-yes">yes</td><td class="mono-cell">"bug" | "feature" | "question"</td></tr>
        <tr><td><code>package</code></td><td class="req-yes">yes</td><td class="mono-cell">"electron"</td></tr>
        <tr><td><code>title</code></td><td class="req-yes">yes</td><td>Short summary</td></tr>
        <tr><td><code>body</code></td><td class="req-yes">yes</td><td>Full description</td></tr>
        <tr><td><code>context</code></td><td class="req-no">no</td><td>Session ID, OS, version…</td></tr>
      </tbody>
    </table>

    <div class="term-block">
      <div class="term-bar">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        <span class="term-title">file a bug report</span>
      </div>
      <pre class="term-body" set:html={`<span class="t-prompt">$</span> curl -X POST https://harness.gg/api/submit \\
  -H "Content-Type: application/json" \\
  -d '{"type":"bug","package":"electron","title":"connect fails","body":"Steps..."}'`}></pre>
    </div>
  </section>

</Layout>

<style>
  /* Fonts */
  h1, h2  { font-family: 'IBM Plex Mono', ui-monospace, monospace; }
  h2      { font-family: 'Source Serif 4', Georgia, serif; }
  code, pre { font-family: 'IBM Plex Mono', ui-monospace, monospace; }

  /* Layout */
  .wrap { max-width: 840px; margin: 0 auto; padding: 0 24px; }
  .sec  { padding: 40px 0; }

  /* Breadcrumb */
  .breadcrumb { font-size: 0.82rem; color: var(--muted-foreground); margin-bottom: 16px; }
  .breadcrumb a { color: var(--muted-foreground); text-decoration: none; }
  .breadcrumb a:hover { color: var(--primary); }
  .breadcrumb span { margin: 0 6px; opacity: 0.4; }

  /* Title row */
  .title-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 14px; }
  h1 { font-size: clamp(1.2rem, 3.5vw, 1.7rem); font-weight: 500; color: var(--foreground); }
  .badge-live { background: color-mix(in oklch, var(--primary) 12%, transparent); color: var(--primary); border: none; font-size: 0.7rem; }
  .badge-ver  { font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; color: var(--muted-foreground); }

  /* Tagline */
  .tagline { font-size: 1rem; color: var(--muted-foreground); max-width: 580px; line-height: 1.75; margin-bottom: 20px; }

  /* Install row */
  .install-row {
    display: flex; align-items: center; justify-content: space-between;
    gap: 12px; padding: 12px 16px;
    background: var(--secondary); border: 2px solid #5a7a8a; border-radius: 10px;
    max-width: 440px; margin-bottom: 16px;
  }
  .install-row code { font-size: 0.88rem; color: var(--foreground); }

  /* External links */
  .ext-links { display: flex; gap: 10px; flex-wrap: wrap; }
  .ext-badge { font-size: 0.78rem; cursor: pointer; transition: all 0.15s; }
  .ext-badge:hover { border-color: var(--primary); color: var(--primary); }

  /* Section headings */
  h2 { font-size: 1.25rem; font-weight: 600; color: var(--foreground); margin-bottom: 16px; }
  .sec-intro { font-size: 0.92rem; color: var(--muted-foreground); margin-bottom: 20px; line-height: 1.7; }
  .sec-intro a { color: var(--primary); }
  .note { font-size: 0.82rem; color: var(--muted-foreground); margin-top: 12px; }

  /* Terminal blocks */
  .term-block { border-radius: 12px; overflow: hidden; box-shadow: 0 8px 30px rgba(30,42,52,0.12); border: 2px solid #5a7a8a; }
  .term-bar {
    display: flex; align-items: center; gap: 6px; padding: 10px 16px;
    background: #283440; border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .dot { width: 10px; height: 10px; border-radius: 50%; background: #7a9aaa; opacity: 0.5; }
  .term-title { margin-left: 8px; font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; color: rgba(255,255,255,0.2); }
  .term-body {
    padding: 20px 24px; font-family: 'IBM Plex Mono', monospace;
    font-size: 0.82rem; line-height: 1.85;
    background: #1e2830; color: #c4ccd4;
    white-space: pre-wrap; word-break: break-all;
  }
  .t-comment { color: rgba(255,255,255,0.2); }
  .t-prompt  { color: #7a9aaa; user-select: none; }
  .t-json    { color: rgba(255,255,255,0.3); }

  /* Command cards */
  .cmd-list  { display: flex; flex-direction: column; gap: 16px; }
  .cmd-card  { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px 22px; }
  .cmd-head  { margin-bottom: 10px; }
  .cmd-name  { font-size: 0.95rem; font-weight: 500; color: var(--primary); }
  .cmd-synopsis {
    font-family: 'IBM Plex Mono', monospace; font-size: 0.78rem; color: var(--muted-foreground);
    background: var(--secondary); padding: 9px 14px; border-radius: 8px;
    margin-bottom: 10px; overflow-x: auto; white-space: pre-wrap; word-break: break-all;
    border: 2px solid #5a7a8a;
  }
  .cmd-desc { font-size: 0.87rem; color: var(--muted-foreground); margin-bottom: 14px; line-height: 1.65; }

  /* Tables */
  .flag-table { width: 100%; border-collapse: collapse; font-size: 0.84rem; }
  .flag-table th {
    text-align: left; padding: 7px 12px;
    font-size: 0.73rem; font-weight: 600; letter-spacing: 0.03em;
    color: var(--muted-foreground); border-bottom: 1px solid var(--border);
  }
  .flag-table td {
    padding: 8px 12px; border-bottom: 1px solid var(--border);
    color: var(--muted-foreground); vertical-align: top; line-height: 1.5;
  }
  .flag-table td:first-child code { color: var(--foreground); font-size: 0.8rem; }
  .req-yes { color: var(--primary) !important; font-size: 0.8rem; font-weight: 500; }
  .req-no  { color: var(--muted-foreground) !important; font-size: 0.8rem; }
  .mono-cell { font-family: 'IBM Plex Mono', monospace; font-size: 0.8rem; }

  /* Response shape */
  .shape-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
  .shape-label { font-size: 0.75rem; font-weight: 600; color: var(--muted-foreground); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 8px; }
  .code-block {
    background: #1e2830; color: #c4ccd4; font-family: 'IBM Plex Mono', monospace;
    font-size: 0.78rem; padding: 18px 20px; border-radius: 12px; overflow-x: auto; line-height: 1.7;
    border: 2px solid #5a7a8a;
  }
  .inline-code { background: var(--secondary); padding: 1px 6px; border-radius: 4px; font-size: 0.85em; }

  @media (max-width: 600px) {
    .shape-grid { grid-template-columns: 1fr; }
    h1 { font-size: 1.2rem; }
  }
</style>
